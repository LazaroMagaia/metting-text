<!DOCTYPE html>
<html>

<head>
  <link rel="shortcut icon" href="https://videosdk.live/favicon/favicon.ico" />
  <meta charset="UTF-8" />

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" />

  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
  <title>JS-SDK | videosdk.live</title>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <title>JS-SDK | videosdk.live</title>
  <style>
    #screenShare {
      /* margin-top: 20px; */
      width: 80%;
    }

    audio {
      display: none;
    }
  </style>
</head>

<body>
  <div id="join-screen">
    <!-- Create new Meeting Button -->
    <button id="createMeetingBtn">New Meeting</button>
    OR
    <!-- Join existing Meeting -->
    <input type="text" id="meetingIdTxt" placeholder="Enter Meeting id" />
    <button id="joinBtn">Join Meeting</button>
  </div>

  <!-- for Managing meeting status -->
  <div id="textDiv"></div>

  <div id="grid-screen" style="display: none">
  <!-- Existing content -->
  <h3 id="meetingIdHeading"></h3>
  <button id="leaveBtn">Leave</button>
  <button id="endCallBtn">End Call</button>
  <button id="toggleMicBtn">Toggle Mic</button>
  <button id="toggleWebCamBtn">Toggle WebCam</button>
  <!-- Add Screen Share Buttons -->
  <button id="startScreenShareBtn">Start Screen Share</button>
  <button id="stopScreenShareBtn">Stop Screen Share</button>
  <!-- Video Container -->
  <div class="row" id="videoContainer"></div>
</div>



<script>
// Getting Elements from DOM
const joinButton = document.getElementById("joinBtn");
const leaveButton = document.getElementById("leaveBtn");
const endCallButton = document.getElementById("endCallBtn");
const toggleMicButton = document.getElementById("toggleMicBtn");
const toggleWebCamButton = document.getElementById("toggleWebCamBtn");
const createButton = document.getElementById("createMeetingBtn");
const videoContainer = document.getElementById("videoContainer");
const textDiv = document.getElementById("textDiv");
const meetingIdInput = document.getElementById("meetingIdTxt");  // Input for meeting ID
const nameInput = document.getElementById("participantName");  // Input for participant's name
let TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhcGlrZXkiOiI2MzdjMzQ3ZC1lMWI4LTRjMDAtYjlkYi0wZGJlMGU3YjEwODEiLCJwZXJtaXNzaW9ucyI6WyJhbGxvd19qb2luIl0sImlhdCI6MTczNjc2NzE3MywiZXhwIjoxNzM3MzcxOTczfQ.uAQgM6J4laBtPaCkM9U2PJ5Um_vFOa64e4PPl4s50GM";

// Declare Variables
let meeting = null;
let meetingId = "";
let isMicOn = false;
let isWebCamOn = false;

// Initialize meeting
function initializeMeeting() {
  window.VideoSDK.config(TOKEN);

  meeting = window.VideoSDK.initMeeting({
    meetingId: meetingId, // required
    name: 'Lazaro Magaia', // get the name from the input
    micEnabled: true, // optional, default: true
    webcamEnabled: true, // optional, default: true
  });

  meeting.join();

  // Creating local participant
  createLocalParticipant();

  // Setting local participant stream
  meeting.localParticipant.on("stream-enabled", (stream) => {
    setTrack(stream, null, meeting.localParticipant, true);
  });

  // Meeting joined event
  meeting.on("meeting-joined", () => {
    textDiv.style.display = "none";
    document.getElementById("grid-screen").style.display = "block";
    document.getElementById("meetingIdHeading").textContent = `Meeting Id: ${meetingId}`;
  });

  // Meeting left event
  meeting.on("meeting-left", () => {
    videoContainer.innerHTML = "";
  });

  // Remote participants event
  meeting.on("participant-joined", (participant) => {
    handleParticipantJoined(participant);
  });

  meeting.on("participant-left", (participant) => {
    handleParticipantLeft(participant);
  });
}

// Handle participant joining
function handleParticipantJoined(participant) {
  let videoElement = createVideoElement(participant.id, participant.displayName);
  let audioElement = createAudioElement(participant.id);

  participant.on("stream-enabled", (stream) => {
    setTrack(stream, audioElement, participant, false);
  });

  videoContainer.appendChild(videoElement);
  videoContainer.appendChild(audioElement);
}

// Handle participant leaving
function handleParticipantLeft(participant) {
  let vElement = document.getElementById(`f-${participant.id}`);
  vElement.remove();

  let aElement = document.getElementById(`a-${participant.id}`);
  aElement.remove();
}

// Create video element
function createVideoElement(pId, name) {
  let videoFrame = document.createElement("div");
  videoFrame.setAttribute("id", `f-${pId}`);

  let videoElement = document.createElement("video");
  videoElement.classList.add("video-frame");
  videoElement.setAttribute("id", `v-${pId}`);
  videoElement.setAttribute("playsinline", true);
  videoElement.setAttribute("width", "300");
  videoFrame.appendChild(videoElement);

  let displayName = document.createElement("div");
  displayName.innerHTML = `Name : ${name}`;
  videoFrame.appendChild(displayName);

  return videoFrame;
}

// Create audio element
function createAudioElement(pId) {
  let audioElement = document.createElement("audio");
  audioElement.setAttribute("autoPlay", "false");
  audioElement.setAttribute("playsInline", "true");
  audioElement.setAttribute("controls", "false");
  audioElement.setAttribute("id", `a-${pId}`);
  audioElement.style.display = "none";
  return audioElement;
}

// Create local participant
function createLocalParticipant() {
  let localParticipant = createVideoElement(meeting.localParticipant.id, meeting.localParticipant.displayName);
  videoContainer.appendChild(localParticipant);
}

// Set media track
function setTrack(stream, audioElement, participant, isLocal) {
  if (stream.kind === "video") {
    isWebCamOn = true;
    const mediaStream = new MediaStream();
    mediaStream.addTrack(stream.track);
    let videoElm = document.getElementById(`v-${participant.id}`);
    videoElm.srcObject = mediaStream;
    videoElm.play().catch((error) => console.error("videoElem.current.play() failed", error));
  }
  if (stream.kind === "audio") {
    if (isLocal) {
      isMicOn = true;
    } else {
      const mediaStream = new MediaStream();
      mediaStream.addTrack(stream.track);
      audioElement.srcObject = mediaStream;
      audioElement.play().catch((error) => console.error("audioElem.play() failed", error));
    }
  }
}

// Join Meeting Button Event Listener
joinButton.addEventListener("click", async () => {
  // Check if both inputs are filled
  if (!name|| !meetingIdInput.value.trim()) {
    alert("Please enter your name and the Meeting ID.");
    return;
  }

  document.getElementById("join-screen").style.display = "none";
  textDiv.textContent = "Joining the meeting...";

  meetingId = meetingIdInput.value;

  initializeMeeting();
});

// Create Meeting Button Event Listener
createButton.addEventListener("click", async () => {
  document.getElementById("join-screen").style.display = "none";
  textDiv.textContent = "Please wait, we are joining the meeting";

  const url = `https://api.videosdk.live/v2/rooms`;
  const options = {
    method: "POST",
    headers: { Authorization: TOKEN, "Content-Type": "application/json" },
  };

  const { roomId } = await fetch(url, options)
    .then((response) => response.json())
    .catch((error) => alert("error", error));

  meetingId = roomId;
  initializeMeeting();
});

// Leave Meeting Button Event Listener
leaveButton.addEventListener("click", async () => {
  meeting?.leave();
  document.getElementById("grid-screen").style.display = "none";
  document.getElementById("join-screen").style.display = "block";
});
endCallButton.addEventListener("click", async () => {
  meeting?.end();
  document.getElementById("grid-screen").style.display = "none";
  document.getElementById("join-screen").style.display = "block";
});

// Toggle Mic Button Event Listener
toggleMicButton.addEventListener("click", async () => {
  if (isMicOn) {
    meeting?.muteMic();
  } else {
    meeting?.unmuteMic();
  }
  isMicOn = !isMicOn;
});

// Toggle Web Cam Button Event Listener
toggleWebCamButton.addEventListener("click", async () => {
  if (isWebCamOn) {
    meeting?.disableWebcam();
    let vElement = document.getElementById(`f-${meeting.localParticipant.id}`);
    vElement.style.display = "none";
  } else {
    meeting?.enableWebcam();
    let vElement = document.getElementById(`f-${meeting.localParticipant.id}`);
    vElement.style.display = "inline";
  }
  isWebCamOn = !isWebCamOn;
});
</script>


<script>
const startScreenShareButton = document.getElementById("startScreenShareBtn");
const stopScreenShareButton = document.getElementById("stopScreenShareBtn");

let isScreenSharing = false;

// Iniciar compartilhamento de tela
startScreenShareButton.addEventListener("click", () => {
  if (!isScreenSharing) {
    meeting?.enableScreenShare((screenShareStream) => {
      console.log("Screen sharing started.");
      isScreenSharing = true;
      startScreenShareButton.style.display = "none";
      stopScreenShareButton.style.display = "block";

      // Adicionar o stream de compartilhamento de tela ao container
      const screenShareElement = document.createElement("video");
      screenShareElement.setAttribute("id", `screen-share-video`);
      screenShareElement.srcObject = new MediaStream([screenShareStream.track]);
      screenShareElement.autoplay = true;
      screenShareElement.playsInline = true;
      screenShareElement.style.width = "100%";
      videoContainer.appendChild(screenShareElement);
    });
  } else {
    alert("Screen sharing is already active.");
  }
});

// Parar compartilhamento de tela
stopScreenShareButton.addEventListener("click", () => {
  if (isScreenSharing) {
    meeting?.disableScreenShare(() => {
      console.log("Screen sharing stopped.");
      isScreenSharing = false;
      startScreenShareButton.style.display = "block";
      stopScreenShareButton.style.display = "none";

      // Remover o elemento de compartilhamento de tela do container
      const screenShareElement = document.getElementById("screen-share-video");
      if (screenShareElement) {
        screenShareElement.remove();
      }
    });
  } else {
    alert("No active screen sharing to stop.");
  }
});

// Atualizar evento de compartilhamento de tela iniciado por outros participantes
meeting?.on("screen-share-started", (participant) => {
  console.log(`${participant.displayName} started screen sharing.`);
});

// Atualizar evento de compartilhamento de tela parado por outros participantes
meeting?.on("screen-share-stopped", (participant) => {
  console.log(`${participant.displayName} stopped screen sharing.`);
});
</script>


  <script src="https://sdk.videosdk.live/js-sdk/0.0.82/videosdk.js"></script>
  <script src="config.js" defer></script>
</body>
<div id="viewer"></div>

</html>